services:

  vpn:
    image: dperson/openvpn-client:latest
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    security_opt:
      - label:disable
    tmpfs:
      - /run
      - /tmp
    stdin_open: true
    tty: true
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - ${APP_DATA_DIR}/data/vpn:/vpn
    environment:
      TZ: America/Los_Angeles

  web:
    image: node:20-alpine
    restart: on-failure
    depends_on:
      - vpn
    ports:
      - "3381:8080"
    volumes:
      - ${APP_DATA_DIR}/data/vpn:/vpn
    entrypoint: ["sh", "-c"]
    command:
      - |
        cat > /tmp/s.js << 'EOF'
        const http=require("http"),fs=require("fs"),path=require("path");
        const VPN_DIR="/vpn",PORT=8080;
        try{fs.mkdirSync(VPN_DIR,{recursive:true})}catch{}
        function lc(){try{return fs.readdirSync(VPN_DIR).filter(f=>/\.(ovpn|conf|crt|key|pem|auth|ca|tls)$/i.test(f))}catch{return[]}}
        function ha(){return fs.existsSync(path.join(VPN_DIR,"vpn.auth"))}
        function pm(buf,b){const s=buf.toString("binary"),ps=s.split("--"+b);for(const p of ps){const m=p.match(/fil
